import streamlit as st
import pandas as pd
from datetime import datetime
import hashlib
import json
import os

# --- H√†m bƒÉm m·∫≠t kh·∫©u ---
def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()

# --- H√†m ƒë·ªçc/ghi JSON ---
def load_json(filename, default_data):
    if os.path.exists(filename):
        with open(filename, 'r', encoding='utf-8') as f:
            return json.load(f)
    else:
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(default_data, f, ensure_ascii=False, indent=2)
        return default_data

def save_json(filename, data):
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

def save_all():
    save_json(USERS_FILE, st.session_state.users)
    save_json(VOTES_FILE, st.session_state.votes)
    save_json(EXPENSES_FILE, st.session_state.expenses)
    save_json(MATCHES_FILE, st.session_state.matches)

# --- ƒê∆∞·ªùng d·∫´n file d·ªØ li·ªáu ---
USERS_FILE = "users.json"
VOTES_FILE = "votes.json"
EXPENSES_FILE = "expenses.json"
MATCHES_FILE = "matches.json"

# --- D·ªØ li·ªáu m·∫∑c ƒë·ªãnh admin ---
default_users = {
    "admin@local": {
        "name": "Admin",
        "phone": "",
        "password_hash": hash_password("Admin@123"),
        "role": "admin",
        "approved": True,
        "wins": 0,
        "balance": 0,
        "votes": []
    }
}

# --- Kh·ªüi t·∫°o d·ªØ li·ªáu ---
if 'users' not in st.session_state:
    st.session_state.users = load_json(USERS_FILE, default_users)

if 'pending_users' not in st.session_state:
    pending = {email: u for email, u in st.session_state.users.items() if not u.get('approved', False)}
    st.session_state.pending_users = pending

if 'votes' not in st.session_state:
    st.session_state.votes = load_json(VOTES_FILE, [])

if 'expenses' not in st.session_state:
    st.session_state.expenses = load_json(EXPENSES_FILE, [])

if 'matches' not in st.session_state:
    st.session_state.matches = load_json(MATCHES_FILE, [])

# --- H√†m ƒëƒÉng nh·∫≠p ---
def login():
    st.title("üîê ƒêƒÉng nh·∫≠p C√¢u l·∫°c b·ªô Pickleball Ban CƒêSCN")
    with st.form("login_form", clear_on_submit=False):
        email = st.text_input("üìß Email")
        password = st.text_input("üîë M·∫≠t kh·∫©u", type="password")
        submitted = st.form_submit_button("ƒêƒÉng nh·∫≠p")
        if submitted:
            if email in st.session_state.users:
                user = st.session_state.users[email]
                if user['password_hash'] == hash_password(password):
                    if user['approved']:
                        st.session_state['login'] = True
                        st.session_state['user_email'] = email
                        st.session_state['user_role'] = user['role']
                        st.success(f"Ch√†o m·ª´ng {user['name']}!")
                       st.experimental_rerun()
                    else:
                        st.error("‚ö†Ô∏è T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c ph√™ duy·ªát. Vui l√≤ng ch·ªù qu·∫£n tr·ªã vi√™n.")
                else:
                    st.error("‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.")
            else:
                st.error("‚ùå Email kh√¥ng t·ªìn t·∫°i.")

# --- H√†m ƒëƒÉng k√Ω ---
def register():
    st.title("üìù ƒêƒÉng k√Ω th√†nh vi√™n m·ªõi")
    with st.form("register_form"):
        name = st.text_input("H·ªç v√† t√™n")
        email = st.text_input("Email")
        phone = st.text_input("S·ªë ƒëi·ªán tho·∫°i")
        password = st.text_input("M·∫≠t kh·∫©u", type="password")
        password2 = st.text_input("Nh·∫≠p l·∫°i m·∫≠t kh·∫©u", type="password")
        submitted = st.form_submit_button("ƒêƒÉng k√Ω")
        if submitted:
            if not (name and email and phone and password and password2):
                st.error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.")
                return
            if password != password2:
                st.error("M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp.")
                return
            if email in st.session_state.users or email in st.session_state.pending_users:
                st.error("Email ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω.")
                return
            new_user = {
                'name': name,
                'phone': phone,
                'password_hash': hash_password(password),
                'role': 'member',
                'approved': False,
                'wins': 0,
                'balance': 0,
                'votes': []
            }
            st.session_state.pending_users[email] = new_user
            st.session_state.users[email] = new_user
            save_all()
            st.success("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ch·ªù qu·∫£n tr·ªã vi√™n ph√™ duy·ªát.")

# --- Tab ph√™ duy·ªát th√†nh vi√™n ---
def admin_approve_users():
    st.header("üõ†Ô∏è Ph√™ duy·ªát th√†nh vi√™n m·ªõi")
    pending = st.session_state.pending_users
    if not pending:
        st.info("Kh√¥ng c√≥ th√†nh vi√™n ch·ªù ph√™ duy·ªát.")
        return
    for email, info in list(pending.items()):
        with st.expander(f"{info['name']} - {email} - {info['phone']}"):
            col1, col2 = st.columns(2)
            with col1:
                if st.button(f"‚úÖ Ph√™ duy·ªát {email}", key=f"approve_{email}"):
                    info['approved'] = True
                    st.session_state.users[email] = info
                    del st.session_state.pending_users[email]
                    save_all()
                    st.success(f"ƒê√£ ph√™ duy·ªát {email}")
                   st.rerun()
            with col2:
                if st.button(f"‚ùå T·ª´ ch·ªëi {email}", key=f"reject_{email}"):
                    if email in st.session_state.users:
                        del st.session_state.users[email]
                    if email in st.session_state.pending_users:
                        del st.session_state.pending_users[email]
                    save_all()
                    st.warning(f"ƒê√£ t·ª´ ch·ªëi {email}")
                   st.rerun()

# --- Tab danh s√°ch th√†nh vi√™n ---
def tab_members():
    st.header("üë• Danh s√°ch th√†nh vi√™n")
    users = st.session_state.users
    members = [u for u in users.values() if u['role'] == 'member' and u['approved']]
    if not members:
        st.info("Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë∆∞·ª£c ph√™ duy·ªát.")
        return

    attendance_count = {email: 0 for email in users if users[email]['role']=='member' and users[email]['approved']}
    for vote in st.session_state.votes:
        for voter in vote['voters']:
            if voter in attendance_count:
                attendance_count[voter] += 1

    data = []
    for u in members:
        email = None
        for e, user in users.items():
            if user == u:
                email = e
                break
        count = attendance_count.get(email, 0)
        data.append({
            'T√™n': u['name'],
            'S·ªë ƒëi·ªán tho·∫°i': u['phone'],
            'S·ªë l·∫ßn tham gia luy·ªán t·∫≠p': count,
            'S·ªë ti·ªÅn c√≤n l·∫°i (VNƒê)': u['balance']
        })

    df = pd.DataFrame(data)
    st.dataframe(df.style.format({"S·ªë ti·ªÅn c√≤n l·∫°i (VNƒê)": "{:,.0f}"}))

# --- Tab Ranking ---
def tab_ranking():
    st.header("üèÜ X·∫øp h·∫°ng th√†nh vi√™n theo s·ªë tr·∫≠n th·∫Øng")
    users = st.session_state.users
    members = {email: u for email, u in users.items() if u['role'] == 'member' and u['approved']}
    if not members:
        st.info("Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë∆∞·ª£c ph√™ duy·ªát.")
        return

    df = pd.DataFrame([
        {'email': email, 'T√™n': u['name'], 'S·ªë tr·∫≠n th·∫Øng': u['wins']}
        for email, u in members.items()
    ])

    def rank_label(wins):
        if wins > 50:
            return "H·∫°t gi·ªëng 1"
        elif wins > 30:
            return "H·∫°t gi·ªëng 2"
        elif wins > 10:
            return "H·∫°t gi·ªëng 3"
        else:
            return ""

    df['X·∫øp lo·∫°i'] = df['S·ªë tr·∫≠n th·∫Øng'].apply(rank_label)
    df = df.sort_values(by='S·ªë tr·∫≠n th·∫Øng', ascending=False).reset_index(drop=True)

    if st.session_state.user_role == 'admin':
        st.subheader("Ch·ªânh s·ª≠a s·ªë tr·∫≠n th·∫Øng")
        df_edit = df[['T√™n', 'S·ªë tr·∫≠n th·∫Øng']].copy().reset_index(drop=True)
        edited_df = st.experimental_data_editor(df_edit, num_rows="dynamic")

        if st.button("L∆∞u c·∫≠p nh·∫≠t"):
            for idx, row in edited_df.iterrows():
                name = row['T√™n']
                wins_new = int(row['S·ªë tr·∫≠n th·∫Øng'])
                email = None
                for e, u in members.items():
                    if u['name'] == name:
                        email = e
                        break
                if email:
                    st.session_state.users[email]['wins'] = wins_new
            save_all()
            st.success("ƒê√£ c·∫≠p nh·∫≠t s·ªë tr·∫≠n th·∫Øng!")
           st.rerun()
    else:
        st.dataframe(df[['T√™n', 'S·ªë tr·∫≠n th·∫Øng', 'X·∫øp lo·∫°i']].style.bar(subset=['S·ªë tr·∫≠n th·∫Øng'], color='#4CAF50'))

    st.subheader("Chi ti·∫øt tr·∫≠n th·∫Øng")
    matches = st.session_state.matches
    if not matches:
        st.info("Ch∆∞a c√≥ tr·∫≠n th·∫Øng n√†o ƒë∆∞·ª£c nh·∫≠p.")
    else:
        member_emails = list(members.keys())
        member_email = st.selectbox("Ch·ªçn th√†nh vi√™n", options=member_emails)
        member_name = users[member_email]['name']
        member_matches = [m for m in matches if m['player_email'] == member_email]
        if not member_matches:
            st.info(f"{member_name} ch∆∞a c√≥ tr·∫≠n th·∫Øng n√†o ƒë∆∞·ª£c nh·∫≠p.")
        else:
            df_match = pd.DataFrame(member_matches)
            df_match_display = df_match.rename(columns={
                'date': 'Ng√†y th·∫Øng',
                'location': 'ƒê·ªãa ƒëi·ªÉm',
                'score': 'T·ªâ s·ªë',
                'min_wins': 'S·ªë tr·∫≠n th·∫Øng t·ªëi thi·ªÉu'
            })
            df_match_display = df_match_display[['Ng√†y th·∫Øng', 'ƒê·ªãa ƒëi·ªÉm', 'T·ªâ s·ªë', 'S·ªë tr·∫≠n th·∫Øng t·ªëi thi·ªÉu']]
            st.dataframe(df_match_display)

    if st.session_state.user_role == 'admin':
        st.subheader("Nh·∫≠p tr·∫≠n th·∫Øng m·ªõi cho th√†nh vi√™n")
        with st.form("input_wins"):
            member_email = st.selectbox("Ch·ªçn th√†nh vi√™n", options=member_emails, key="input_wins_member")
            min_wins = st.number_input("S·ªë tr·∫≠n th·∫Øng t·ªëi thi·ªÉu", min_value=1, step=1)
            date_str = st.date_input("Ng√†y tr·∫≠n th·∫Øng", value=datetime.today())
            location = st.text_input("ƒê·ªãa ƒëi·ªÉm")
            score = st.text_input("T·ªâ s·ªë tr·∫≠n th·∫Øng (v√≠ d·ª• 21:15)")
            submitted = st.form_submit_button("Th√™m tr·∫≠n th·∫Øng")
            if submitted:
                if not location or not score:
                    st.error("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ƒë·ªãa ƒëi·ªÉm v√† t·ªâ s·ªë tr·∫≠n th·∫Øng.")
                else:
                    st.session_state.users[member_email]['wins'] += min_wins
                    st.session_state.matches.append({
                        'player_email': member_email,
                        'min_wins': min_wins,
                        'date': date_str.strftime("%Y-%m-%d"),
                        'location': location,
                        'score': score
                    })
                    save_all()
                    st.success("ƒê√£ th√™m tr·∫≠n th·∫Øng th√†nh c√¥ng!")
                   st.rerun()

# --- Tab Vote ---
def tab_vote():
    st.header("üó≥Ô∏è B√¨nh ch·ªçn tham gia ch∆°i")
    if st.session_state.user_role == 'admin':
        st.subheader("T·∫°o b√¨nh ch·ªçn m·ªõi")
        with st.form("create_vote"):
            date_vote = st.date_input("Ch·ªçn ng√†y tham gia", value=datetime.today())
            weekday = date_vote.strftime("%A")
            weekday_map = {
                "Monday": "Th·ª© Hai",
                "Tuesday": "Th·ª© Ba",
                "Wednesday": "Th·ª© T∆∞",
                "Thursday": "Th·ª© NƒÉm",
                "Friday": "Th·ª© S√°u",
                "Saturday": "Th·ª© B·∫£y",
                "Sunday": "Ch·ªß Nh·∫≠t"
            }
            weekday_vn = weekday_map.get(weekday, weekday)
            description = st.text_area("M√¥ t·∫£ b√¨nh ch·ªçn (v√≠ d·ª•: Bu·ªïi t·∫≠p k·ªπ thu·∫≠t, giao h·ªØu...)")
            submitted = st.form_submit_button("T·∫°o b√¨nh ch·ªçn")
            if submitted:
                for v in st.session_state.votes:
                    if v['date'] == date_vote.strftime("%Y-%m-%d"):
                        st.warning("ƒê√£ c√≥ b√¨nh ch·ªçn cho ng√†y n√†y.")
                        break
                else:
                    st.session_state.votes.append({
                        'date': date_vote.strftime("%Y-%m-%d"),
                        'weekday': weekday_vn,
                        'description': description,
                        'voters': []
                    })
                    save_all()
                    st.success("T·∫°o b√¨nh ch·ªçn th√†nh c√¥ng!")
                   st.rerun()

    if st.session_state.user_role == 'member':
        if not st.session_state.votes:
            st.info("Ch∆∞a c√≥ b√¨nh ch·ªçn n√†o.")
            return
        st.subheader("B√¨nh ch·ªçn tham gia")
        for vote in st.session_state.votes:
            date_str = vote['date']
            voted = st.session_state.user_email in vote['voters']
            desc = vote.get('description', '')
            weekday = vote.get('weekday', '')
            with st.expander(f"{weekday} - {date_str} - {desc}"):
                if voted:
                    st.markdown(f"- ‚úÖ B·∫°n ƒë√£ tham gia b√¨nh ch·ªçn ng√†y **{date_str}**")
                else:
                    if st.button(f"Tham gia ng√†y {date_str}", key=date_str):
                        vote['voters'].append(st.session_state.user_email)
                        save_all()
                        st.success(f"B·∫°n ƒë√£ tham gia b√¨nh ch·ªçn ng√†y {date_str}")
                       st.rerun()

    st.subheader("Th·ªëng k√™ s·ªë l∆∞·ª£ng vote tham gia")
    if not st.session_state.votes:
        st.info("Ch∆∞a c√≥ b√¨nh ch·ªçn n√†o.")
        return
    data = [{'Ng√†y': v['date'], 'Th·ª©': v.get('weekday', ''), 'M√¥ t·∫£': v.get('description', ''), 'S·ªë l∆∞·ª£ng tham gia': len(v['voters'])} for v in st.session_state.votes]
    df = pd.DataFrame(data).sort_values(by='Ng√†y', ascending=False)
    st.dataframe(df.style.bar(subset=['S·ªë l∆∞·ª£ng tham gia'], color='#2196F3'))

# --- Tab Qu·∫£n l√Ω t√†i ch√≠nh ---
def tab_finance():
    st.header("üí∞ Qu·∫£n l√Ω t√†i ch√≠nh")
    users = st.session_state.users
    members = [email for email, u in users.items() if u['role']=='member' and u['approved']]

    st.subheader("Nh·∫≠p s·ªë ti·ªÅn ƒë√≥ng g√≥p c·ªßa th√†nh vi√™n")
    with st.form("input_contribution"):
        member_email = st.selectbox("Ch·ªçn th√†nh vi√™n", options=members)
        amount = st.number_input("S·ªë ti·ªÅn ƒë√≥ng g√≥p (VNƒê)", min_value=0, step=1000)
        submitted = st.form_submit_button("C·∫≠p nh·∫≠t ƒë√≥ng g√≥p")
        if submitted:
            users[member_email]['balance'] += amount
            save_all()
            st.success("C·∫≠p nh·∫≠t ƒë√≥ng g√≥p th√†nh c√¥ng!")
           st.rerun()

    if st.session_state.user_role == 'admin':
        st.subheader("Nh·∫≠p chi ph√≠ bu·ªïi t·∫≠p")
        with st.form("input_expense"):
            if not st.session_state.votes:
                st.info("Ch∆∞a c√≥ b√¨nh ch·ªçn n√†o ƒë·ªÉ x√°c ƒë·ªãnh ng∆∞·ªùi tham gia.")
            else:
                vote_dates = [v['date'] for v in st.session_state.votes]
                date_expense = st.selectbox("Ch·ªçn ng√†y bu·ªïi t·∫≠p", options=vote_dates)
                cost = st.number_input("Chi ph√≠ bu·ªïi t·∫≠p (VNƒê)", min_value=0, step=1000)
                submitted = st.form_submit_button("Nh·∫≠p chi ph√≠")
                if submitted:
                    vote = next((v for v in st.session_state.votes if v['date'] == date_expense), None)
                    if vote is None or len(vote['voters']) == 0:
                        st.error("Ng√†y n√†y kh√¥ng c√≥ th√†nh vi√™n tham gia.")
                    else:
                        per_person = cost / len(vote['voters'])
                        for email in vote['voters']:
                            users[email]['balance'] -= per_person
                        st.session_state.expenses.append({'date': date_expense, 'amount': cost, 'participants': vote['voters']})
                        save_all()
                        st.success(f"ƒê√£ nh·∫≠p chi ph√≠ v√† tr·ª´ ti·ªÅn cho {len(vote['voters'])} th√†nh vi√™n.")
                       st.rerun()
    else:
        st.info("Ch·ª©c nƒÉng nh·∫≠p chi ph√≠ bu·ªïi t·∫≠p ch·ªâ d√†nh cho qu·∫£n tr·ªã vi√™n.")

    st.subheader("S·ªë d∆∞ t√†i ch√≠nh c√°c th√†nh vi√™n")
    attendance_count = {email: 0 for email in members}
    for vote in st.session_state.votes:
        for voter in vote['voters']:
            if voter in attendance_count:
                attendance_count[voter] += 1

    total_expense = sum(e['amount'] for e in st.session_state.expenses)
    total_sessions = len(st.session_state.votes) if st.session_state.votes else 1
    avg_cost_per_session = total_expense / total_sessions if total_sessions > 0 else 0

    data = []
    for email in members:
        name = users[email]['name']
        balance = users[email]['balance']
        sessions = attendance_count.get(email, 0)
        need_pay = sessions * avg_cost_per_session
        data.append({
            'T√™n': name,
            'Bu·ªïi t·∫≠p': sessions,
            'S·ªë ti·ªÅn c·∫ßn ƒë√≥ng g√≥p (VNƒê)': need_pay,
            'S·ªë ti·ªÅn c√≤n l·∫°i (VNƒê)': balance
        })

    df = pd.DataFrame(data)
    st.dataframe(
        df.style.format({
            "S·ªë ti·ªÅn c·∫ßn ƒë√≥ng g√≥p (VNƒê)": "{:,.0f}",
            "S·ªë ti·ªÅn c√≤n l·∫°i (VNƒê)": "{:,.0f}"
        }).bar(subset=['S·ªë ti·ªÅn c√≤n l·∫°i (VNƒê)'], color='#FF9800')
    )

# --- Tab Home ---
def tab_home():
    st.header("üìä Trang ch·ªß - Th·ªëng k√™ t·ªïng quan")

    users = st.session_state.users
    members = [u for u in users.values() if u['role']=='member' and u['approved']]
    if not members:
        st.info("Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë∆∞·ª£c ph√™ duy·ªát.")
        return

    df = pd.DataFrame(members)

    col1, col2, col3 = st.columns(3)

    with col1:
        st.subheader("üèÖ Top th√†nh vi√™n theo s·ªë tr·∫≠n th·∫Øng")
        df_rank = df[['name', 'wins']].sort_values(by='wins', ascending=False).head(10)
        st.bar_chart(df_rank.set_index('name'))

    with col2:
        st.subheader("üíµ Top th√†nh vi√™n theo s·ªë ti·ªÅn c√≤n l·∫°i")
        df_balance = df[['name', 'balance']].sort_values(by='balance', ascending=False).head(10)
        st.bar_chart(df_balance.set_index('name'))

    with col3:
        st.subheader("üó≥Ô∏è S·ªë l·∫ßn tham gia ch∆°i")
        vote_counts = {email:0 for email in users}
        for vote in st.session_state.votes:
            for v in vote['voters']:
                vote_counts[v] = vote_counts.get(v, 0) + 1
        data = []
        for email, count in vote_counts.items():
            user = users.get(email)
            if user and user['role']=='member' and user['approved']:
                data.append({'name': user['name'], 'votes': count})
        df_vote = pd.DataFrame(data)
        if not df_vote.empty:
            df_vote = df_vote.sort_values(by='votes', ascending=False).head(10)
            st.bar_chart(df_vote.set_index('name'))
        else:
            st.info("Ch∆∞a c√≥ d·ªØ li·ªáu b√¨nh ch·ªçn tham gia.")

# --- Main app ---
def main():
    st.set_page_config(page_title="Qu·∫£n l√Ω CLB Pickleball Ban CƒêSCN", layout="wide", page_icon="üèì")

    st.sidebar.title("üèì Menu")
    if 'login' not in st.session_state or not st.session_state.login:
        choice = st.sidebar.radio("Ch·ªçn ch·ª©c nƒÉng", ["ƒêƒÉng nh·∫≠p", "ƒêƒÉng k√Ω"])
        if choice == "ƒêƒÉng nh·∫≠p":
            login()
        else:
            register()
    else:
        user = st.session_state.users[st.session_state.user_email]
        st.sidebar.markdown(f"**Xin ch√†o, {user['name']}** ({st.session_state.user_role})")
        if st.sidebar.button("üö™ ƒêƒÉng xu·∫•t"):
            st.session_state.login = False
            st.rerun()

        tabs = ["Home", "Th√†nh vi√™n", "Ranking", "Vote", "Qu·∫£n l√Ω t√†i ch√≠nh"]
        if st.session_state.user_role == 'admin':
            tabs.insert(1, "Ph√™ duy·ªát th√†nh vi√™n")

        choice = st.sidebar.radio("Ch·ªçn ch·ª©c nƒÉng", tabs)

        if choice == "Home":
            tab_home()
        elif choice == "Ph√™ duy·ªát th√†nh vi√™n":
            admin_approve_users()
        elif choice == "Th√†nh vi√™n":
            tab_members()
        elif choice == "Ranking":
            tab_ranking()
        elif choice == "Vote":
            tab_vote()
        elif choice == "Qu·∫£n l√Ω t√†i ch√≠nh":
            tab_finance()

if __name__ == "__main__":
    main()