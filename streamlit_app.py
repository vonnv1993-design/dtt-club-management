import streamlit as st
import sqlite3
import hashlib
import pandas as pd
from datetime import datetime, timedelta
import os

# Page configuration
st.set_page_config(
    page_title="DTT PICKLEBALL CLUB",
    page_icon="üèì",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# Custom CSS for modern, responsive design
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(90deg, #1f4e79 0%, #2d5a87 100%);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        color: white;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .nav-menu {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .user-info {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #1f4e79;
        margin: 10px 0;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1f4e79;
        margin: 0;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    .member-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 3px solid #28a745;
    }
    
    .pending-card {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 4px solid #f39c12;
    }
    
    .alert-card {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 4px solid #f39c12;
    }
    
    .danger-card {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 4px solid #dc3545;
    }
    
    .vote-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin: 15px 0;
        border: 1px solid #e9ecef;
    }
    
    .ranking-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin: 10px 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .expense-card {
        background: #fff8e1;
        border: 1px solid #ffcc02;
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 4px solid #ff9800;
    }
    
    .simple-chart {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin: 15px 0;
    }
    
    .edit-form {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        padding: 20px;
        border-radius: 10px;
        margin: 15px 0;
        border-left: 4px solid #2196f3;
    }
    
    @media (max-width: 768px) {
        .stat-card {
            margin: 5px 0;
            padding: 15px;
        }
        .stat-number {
            font-size: 2rem;
        }
        .main-header {
            padding: 15px;
        }
    }
</style>
""", unsafe_allow_html=True)

# Database file path
DB_FILE = "pickleball_club.db"

# Database initialization
def init_database():
    """Kh·ªüi t·∫°o database SQLite v·ªõi file c·ªë ƒë·ªãnh"""
    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        
        # Users table
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                full_name TEXT NOT NULL,
                email TEXT UNIQUE NOT NULL,
                phone TEXT NOT NULL,
                birth_date TEXT NOT NULL,
                password TEXT NOT NULL,
                is_approved INTEGER DEFAULT 0,
                is_admin INTEGER DEFAULT 0,
                created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                approved_at TEXT,
                approved_by TEXT
            )
        ''')
        
        # Rankings table
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS rankings (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                match_date TEXT,
                location TEXT,
                score TEXT,
                created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (id)
            )
        ''')
        
        # Vote sessions table
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS vote_sessions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                session_date TEXT,
                description TEXT,
                created_at TEXT DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # Votes table
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS votes (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                session_date TEXT,
                created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (id)
            )
        ''')
        
        # Finances table
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS finances (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                amount INTEGER,
                transaction_type TEXT,
                description TEXT,
                session_date TEXT,
                court_fee INTEGER DEFAULT 0,
                water_fee INTEGER DEFAULT 0,
                other_fee INTEGER DEFAULT 0,
                total_participants INTEGER DEFAULT 0,
                created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (id)
            )
        ''')
        
        # Insert default admin user if not exists
        cursor.execute('SELECT COUNT(*) FROM users WHERE email = ?', ('admin@local',))
        if cursor.fetchone()[0] == 0:
            cursor.execute('''
                INSERT INTO users (full_name, email, phone, birth_date, password, is_approved, is_admin, created_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', ('Administrator', 'admin@local', '0000000000', '1990-01-01', 
                  hashlib.sha256('Admin@123'.encode()).hexdigest(), 1, 1, 
                  datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
        
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        st.error(f"L·ªói kh·ªüi t·∫°o database: {str(e)}")
        return False

def get_db_connection():
    """T·∫°o k·∫øt n·ªëi database an to√†n"""
    return sqlite3.connect(DB_FILE, check_same_thread=False)

# Authentication functions
def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()

def register_user(full_name, email, phone, birth_date, password):
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO users (full_name, email, phone, birth_date, password, created_at)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (full_name, email, phone, str(birth_date), hash_password(password), 
              datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
        
        conn.commit()
        conn.close()
        return True, "ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ch·ªù admin ph√™ duy·ªát."
    except sqlite3.IntegrityError:
        if conn:
            conn.close()
        return False, "Email ƒë√£ t·ªìn t·∫°i!"
    except Exception as e:
        if conn:
            conn.close()
        return False, f"L·ªói ƒëƒÉng k√Ω: {str(e)}"

def login_user(email, password):
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, full_name, is_approved, is_admin FROM users 
            WHERE email = ? AND password = ?
        ''', (email, hash_password(password)))
        
        user = cursor.fetchone()
        conn.close()
        
        if user:
            if user[2] == 1 or user[3] == 1:  # approved or admin
                return True, {
                    'id': user[0],
                    'name': user[1],
                    'is_admin': user[3] == 1
                }
            else:
                return False, "T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c ph√™ duy·ªát!"
        return False, "Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!"
    except Exception as e:
        return False, f"L·ªói ƒëƒÉng nh·∫≠p: {str(e)}"

# Database helper functions
def get_pending_members():
    """L·∫•y danh s√°ch th√†nh vi√™n ch·ªù ph√™ duy·ªát"""
    try:
        conn = get_db_connection()
        df = pd.read_sql_query('''
            SELECT id, full_name, email, phone, birth_date, created_at
            FROM users 
            WHERE is_approved = 0 AND is_admin = 0
            ORDER BY created_at DESC
        ''', conn)
        conn.close()
        return df
    except Exception as e:
        st.error(f"L·ªói l·∫•y pending members: {str(e)}")
        return pd.DataFrame()

def get_approved_members():
    """L·∫•y danh s√°ch th√†nh vi√™n ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát"""
    try:
        conn = get_db_connection()
        df = pd.read_sql_query('''
            SELECT id, full_name, email, phone, birth_date
            FROM users 
            WHERE is_approved = 1 AND is_admin = 0
            ORDER BY full_name
        ''', conn)
        conn.close()
        return df
    except Exception as e:
        st.error(f"L·ªói l·∫•y approved members: {str(e)}")
        return pd.DataFrame()

def approve_member(user_id, admin_name):
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            UPDATE users 
            SET is_approved = 1, approved_at = ?, approved_by = ?
            WHERE id = ?
        ''', (datetime.now().strftime('%Y-%m-%d %H:%M:%S'), admin_name, user_id))
        
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        st.error(f"L·ªói ph√™ duy·ªát: {str(e)}")
        return False

def reject_member(user_id):
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute('DELETE FROM users WHERE id = ?', (user_id,))
        
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        st.error(f"L·ªói t·ª´ ch·ªëi: {str(e)}")
        return False

# TH√äM C√ÅC H√ÄM QU·∫¢N L√ù TH√ÄNH VI√äN M·ªöI
def add_member_direct(full_name, email, phone, birth_date, password):
    """Admin th√™m th√†nh vi√™n tr·ª±c ti·∫øp (ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát ngay)"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO users (full_name, email, phone, birth_date, password, is_approved, created_at, approved_at, approved_by)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (full_name, email, phone, str(birth_date), hash_password(password), 1, 
              datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
              datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
              'Admin'))
        
        conn.commit()
        conn.close()
        return True, "ƒê√£ th√™m th√†nh vi√™n th√†nh c√¥ng!"
    except sqlite3.IntegrityError:
        if conn:
            conn.close()
        return False, "Email ƒë√£ t·ªìn t·∫°i!"
    except Exception as e:
        if conn:
            conn.close()
        return False, f"L·ªói th√™m th√†nh vi√™n: {str(e)}"

def update_member(user_id, full_name, email, phone, birth_date, password=None):
    """C·∫≠p nh·∫≠t th√¥ng tin th√†nh vi√™n"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        if password:
            cursor.execute('''
                UPDATE users 
                SET full_name = ?, email = ?, phone = ?, birth_date = ?, password = ?
                WHERE id = ? AND is_admin = 0
            ''', (full_name, email, phone, str(birth_date), hash_password(password), user_id))
        else:
            cursor.execute('''
                UPDATE users 
                SET full_name = ?, email = ?, phone = ?, birth_date = ?
                WHERE id = ? AND is_admin = 0
            ''', (full_name, email, phone, str(birth_date), user_id))
        
        conn.commit()
        conn.close()
        return True, "ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin th√†nh vi√™n!"
    except sqlite3.IntegrityError:
        if conn:
            conn.close()
        return False, "Email ƒë√£ t·ªìn t·∫°i!"
    except Exception as e:
        if conn:
            conn.close()
        return False, f"L·ªói c·∫≠p nh·∫≠t: {str(e)}"

def delete_member(user_id):
    """X√≥a th√†nh vi√™n v√† t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # X√≥a c√°c d·ªØ li·ªáu li√™n quan tr∆∞·ªõc
        cursor.execute('DELETE FROM rankings WHERE user_id = ?', (user_id,))
        cursor.execute('DELETE FROM votes WHERE user_id = ?', (user_id,))
        cursor.execute('DELETE FROM finances WHERE user_id = ?', (user_id,))
        
        # X√≥a user (ch·ªâ x√≥a th√†nh vi√™n, kh√¥ng x√≥a admin)
        cursor.execute('DELETE FROM users WHERE id = ? AND is_admin = 0', (user_id,))
        
        affected_rows = cursor.rowcount
        conn.commit()
        conn.close()
        
        if affected_rows > 0:
            return True, "ƒê√£ x√≥a th√†nh vi√™n v√† t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan!"
        else:
            return False, "Kh√¥ng th·ªÉ x√≥a (c√≥ th·ªÉ l√† admin ho·∫∑c th√†nh vi√™n kh√¥ng t·ªìn t·∫°i)!"
            
    except Exception as e:
        if conn:
            conn.close()
        return False, f"L·ªói x√≥a th√†nh vi√™n: {str(e)}"

def get_member_by_id(user_id):
    """L·∫•y th√¥ng tin th√†nh vi√™n theo ID"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, full_name, email, phone, birth_date
            FROM users 
            WHERE id = ? AND is_admin = 0
        ''', (user_id,))
        
        member = cursor.fetchone()
        conn.close()
        
        if member:
            return {
                'id': member[0],
                'full_name': member[1],
                'email': member[2],
                'phone': member[3],
                'birth_date': member[4]
            }
        return None
    except Exception as e:
        st.error(f"L·ªói l·∫•y th√¥ng tin th√†nh vi√™n: {str(e)}")
        return None

def get_rankings():
    try:
        conn = get_db_connection()
        df = pd.read_sql_query('''
            SELECT u.full_name, COUNT(r.id) as total_wins
            FROM users u
            LEFT JOIN rankings r ON u.id = r.user_id
            WHERE u.is_approved = 1 AND u.is_admin = 0
            GROUP BY u.id, u.full_name
            ORDER BY total_wins DESC
        ''', conn)
        conn.close()
        return df
    except Exception as e:
        st.error(f"L·ªói l·∫•y rankings: {str(e)}")
        return pd.DataFrame()

def add_ranking(user_name, wins, match_date, location, score):
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # Get user_id
        cursor.execute('SELECT id FROM users WHERE full_name = ? AND is_approved = 1 AND is_admin = 0', (user_name,))
        user = cursor.fetchone()
        
        if user:
            for _ in range(wins):
                cursor.execute('''
                    INSERT INTO rankings (user_id, match_date, location, score, created_at)
                    VALUES (?, ?, ?, ?, ?)
                ''', (user[0], str(match_date), location, score, datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
        
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        st.error(f"L·ªói th√™m ranking: {str(e)}")
        return False

def get_vote_sessions():
    try:
        conn = get_db_connection()
        df = pd.read_sql_query('''
            SELECT vs.id, vs.session_date, vs.description, 
                   COUNT(CASE WHEN u.is_admin = 0 THEN v.id END) as vote_count
            FROM vote_sessions vs
            LEFT JOIN votes v ON vs.session_date = v.session_date
            LEFT JOIN users u ON v.user_id = u.id
            GROUP BY vs.id, vs.session_date, vs.description
            ORDER BY vs.session_date DESC
        ''', conn)
        conn.close()
        return df
    except Exception as e:
        st.error(f"L·ªói l·∫•y vote sessions: {str(e)}")
        return pd.DataFrame()

def create_vote_session(session_date, description):
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO vote_sessions (session_date, description, created_at)
            VALUES (?, ?, ?)
        ''', (str(session_date), description, datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
        
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        st.error(f"L·ªói t·∫°o vote session: {str(e)}")
        return False

def vote_for_session(user_id, session_date):
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # Check if already voted
        cursor.execute('''
            SELECT id FROM votes WHERE user_id = ? AND session_date = ?
        ''', (user_id, str(session_date)))
        
        if not cursor.fetchone():
            cursor.execute('''
                INSERT INTO votes (user_id, session_date, created_at)
                VALUES (?, ?, ?)
            ''', (user_id, str(session_date), datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
            conn.commit()
            conn.close()
            return True
        else:
            conn.close()
            return False
    except Exception as e:
        st.error(f"L·ªói vote: {str(e)}")
        return False

def get_vote_details(session_date):
    try:
        conn = get_db_connection()
        df = pd.read_sql_query('''
            SELECT u.full_name, v.created_at
            FROM votes v
            JOIN users u ON v.user_id = u.id
            WHERE v.session_date = ? AND u.is_admin = 0
            ORDER BY v.created_at
        ''', conn, params=[str(session_date)])
        conn.close()
        return df
    except Exception as e:
        st.error(f"L·ªói l·∫•y vote details: {str(e)}")
        return pd.DataFrame()

def add_contribution(user_name, amount):
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute('SELECT id FROM users WHERE full_name = ? AND is_approved = 1 AND is_admin = 0', (user_name,))
        user = cursor.fetchone()
        
        if user:
            cursor.execute('''
                INSERT INTO finances (user_id, amount, transaction_type, description, created_at)
                VALUES (?, ?, ?, ?, ?)
            ''', (user[0], amount, 'contribution', 'ƒê√≥ng qu·ªπ', datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
        
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        st.error(f"L·ªói th√™m ƒë√≥ng g√≥p: {str(e)}")
        return False

def get_vote_sessions_for_expense():
    """L·∫•y danh s√°ch c√°c bu·ªïi ƒë√£ c√≥ vote ƒë·ªÉ ch·ªçn khi th√™m chi ph√≠"""
    try:
        conn = get_db_connection()
        df = pd.read_sql_query('''
            SELECT vs.session_date, vs.description, 
                   COUNT(CASE WHEN u.is_admin = 0 THEN v.id END) as vote_count
            FROM vote_sessions vs
            LEFT JOIN votes v ON vs.session_date = v.session_date
            LEFT JOIN users u ON v.user_id = u.id
            GROUP BY vs.session_date, vs.description
            HAVING vote_count > 0
            ORDER BY vs.session_date DESC
        ''', conn)
        conn.close()
        return df
    except Exception as e:
        st.error(f"L·ªói l·∫•y vote sessions for expense: {str(e)}")
        return pd.DataFrame()

def add_expense(session_date, court_fee, water_fee, other_fee, description):
    """Th√™m chi ph√≠ cho bu·ªïi t·∫≠p v√† chia ƒë·ªÅu cho c√°c th√†nh vi√™n ƒë√£ vote"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        total_fee = court_fee + water_fee + other_fee
        
        # L·∫•y danh s√°ch th√†nh vi√™n ƒë√£ vote cho bu·ªïi n√†y (ch·ªâ th√†nh vi√™n, kh√¥ng bao g·ªìm admin)
        cursor.execute('''
            SELECT v.user_id FROM votes v
            JOIN users u ON v.user_id = u.id
            WHERE v.session_date = ? AND u.is_admin = 0
        ''', (str(session_date),))
        
        voters = cursor.fetchall()
        
        if voters:
            cost_per_person = total_fee // len(voters)  # Chi ph√≠ m·ªói ng∆∞·ªùi
            
            # Th√™m chi ph√≠ cho t·ª´ng th√†nh vi√™n ƒë√£ vote
            for voter in voters:
                cursor.execute('''
                    INSERT INTO finances (user_id, amount, transaction_type, description, session_date, 
                                        court_fee, water_fee, other_fee, total_participants, created_at)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ''', (voter[0], -cost_per_person, 'expense', description, str(session_date), 
                      court_fee//len(voters), water_fee//len(voters), other_fee//len(voters), 
                      len(voters), datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
            
            conn.commit()
            conn.close()
            return True, f"ƒê√£ chia {total_fee:,} VNƒê cho {len(voters)} th√†nh vi√™n ({cost_per_person:,} VNƒê/ng∆∞·ªùi)"
        else:
            conn.close()
            return False, "Kh√¥ng c√≥ th√†nh vi√™n n√†o vote cho bu·ªïi n√†y"
    except Exception as e:
        return False, f"L·ªói th√™m chi ph√≠: {str(e)}"

def get_financial_summary():
    try:
        conn = get_db_connection()
        df = pd.read_sql_query('''
            SELECT u.full_name,
                   COALESCE(SUM(CASE WHEN f.transaction_type = 'contribution' THEN f.amount ELSE 0 END), 0) as total_contribution,
                   COUNT(CASE WHEN f.transaction_type = 'expense' THEN 1 END) as sessions_attended,
                   COALESCE(SUM(CASE WHEN f.transaction_type = 'expense' THEN f.amount ELSE 0 END), 0) as total_expenses,
                   COALESCE(SUM(f.amount), 0) as balance
            FROM users u
            LEFT JOIN finances f ON u.id = f.user_id
            WHERE u.is_approved = 1 AND u.is_admin = 0
            GROUP BY u.id, u.full_name
            ORDER BY balance DESC
        ''', conn)
        conn.close()
        return df
    except Exception as e:
        st.error(f"L·ªói l·∫•y financial summary: {str(e)}")
        return pd.DataFrame()

def get_expense_history():
    """L·∫•y l·ªãch s·ª≠ chi ph√≠ theo t·ª´ng bu·ªïi t·∫≠p"""
    try:
        conn = get_db_connection()
        df = pd.read_sql_query('''
            SELECT 
                f.session_date,
                f.description,
                MAX(f.total_participants) as participants_count,
                SUM(-f.amount) as total_cost,
                (-f.amount) as cost_per_person,
                f.created_at
            FROM finances f
            WHERE f.transaction_type = 'expense' AND f.session_date != ''
            GROUP BY f.session_date, f.description, f.amount, f.created_at
            ORDER BY f.session_date DESC, f.created_at DESC
        ''', conn)
        conn.close()
        return df
    except Exception as e:
        st.error(f"L·ªói l·∫•y expense history: {str(e)}")
        return pd.DataFrame()

def get_alerts():
    alerts = []
    
    try:
        conn = get_db_connection()
        
        # Check low balance alert
        cursor = conn.cursor()
        cursor.execute('''
            SELECT u.full_name, COALESCE(SUM(f.amount), 0) as balance
            FROM users u
            LEFT JOIN finances f ON u.id = f.user_id
            WHERE u.is_approved = 1 AND u.is_admin = 0
            GROUP BY u.id, u.full_name
            HAVING balance < 100000
        ''')
        
        low_balance_users = cursor.fetchall()
        for user in low_balance_users:
            alerts.append(f"‚ö†Ô∏è {user[0]} c√≥ s·ªë d∆∞ th·∫•p: {user[1]:,} VNƒê")
        
        # Check low voting activity
        thirty_days_ago = (datetime.now() - timedelta(days=30)).strftime('%Y-%m-%d')
        cursor.execute('''
            SELECT u.full_name, COUNT(v.id) as vote_count
            FROM users u
            LEFT JOIN votes v ON u.id = v.user_id AND v.created_at >= ?
            WHERE u.is_approved = 1 AND u.is_admin = 0
            GROUP BY u.id, u.full_name
            HAVING vote_count < 3
        ''', (thirty_days_ago,))
        
        low_activity_users = cursor.fetchall()
        for user in low_activity_users:
            alerts.append(f"üìä {user[0]} vote √≠t trong 30 ng√†y qua: {user[1]} l·∫ßn")
        
        conn.close()
    except Exception as e:
        st.error(f"L·ªói l·∫•y alerts: {str(e)}")
    
    return alerts

# Initialize database
if 'db_initialized' not in st.session_state:
    st.session_state.db_initialized = init_database()

# Initialize session state
if 'logged_in' not in st.session_state:
    st.session_state.logged_in = False
if 'user' not in st.session_state:
    st.session_state.user = None
if 'current_page' not in st.session_state:
    st.session_state.current_page = "üè† Trang ch·ªß"
if 'editing_member_id' not in st.session_state:
    st.session_state.editing_member_id = None

# Main app
def main():
    if not st.session_state.db_initialized:
        st.error("Kh√¥ng th·ªÉ kh·ªüi t·∫°o database. Vui l√≤ng th·ª≠ l·∫°i!")
        return
        
    st.markdown("""
        <div class="main-header">
            <h1>üèì DTT PICKLEBALL CLUB</h1>
            <p>H·ªá th·ªëng qu·∫£n l√Ω c√¢u l·∫°c b·ªô Pickleball chuy√™n nghi·ªáp</p>
        </div>
    """, unsafe_allow_html=True)
    
    # Hi·ªÉn th·ªã th√¥ng tin database
    if os.path.exists(DB_FILE):
        file_size = os.path.getsize(DB_FILE)
        st.sidebar.success(f"üíæ Database: {file_size} bytes")
    else:
        st.sidebar.warning("‚ö†Ô∏è Database file kh√¥ng t·ªìn t·∫°i")
    
    if not st.session_state.logged_in:
        show_auth_page()
    else:
        show_main_app()

def show_auth_page():
    tab1, tab2 = st.tabs(["üîê ƒêƒÉng nh·∫≠p", "üìù ƒêƒÉng k√Ω"])
    
    with tab1:
        st.subheader("ƒêƒÉng nh·∫≠p v√†o h·ªá th·ªëng")
        
        with st.form("login_form"):
            email = st.text_input("üìß Email", placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ email")
            password = st.text_input("üîí M·∫≠t kh·∫©u", type="password", placeholder="Nh·∫≠p m·∫≠t kh·∫©u")
            
            if st.form_submit_button("ƒêƒÉng nh·∫≠p", use_container_width=True):
                if email and password:
                    success, result = login_user(email, password)
                    if success:
                        st.session_state.logged_in = True
                        st.session_state.user = result
                        st.rerun()
                    else:
                        st.error(result)
                else:
                    st.error("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!")
        
        st.info("üí° C·∫ßn h·ªó tr·ª£ li√™n h·ªá vonnv")
    
    with tab2:
        st.subheader("ƒêƒÉng k√Ω th√†nh vi√™n m·ªõi")
        
        with st.form("register_form"):
            full_name = st.text_input("üë§ H·ªç v√† t√™n", placeholder="Nh·∫≠p h·ªç v√† t√™n ƒë·∫ßy ƒë·ªß")
            email = st.text_input("üìß Email", placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ email")
            phone = st.text_input("üì± S·ªë ƒëi·ªán tho·∫°i", placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i")
            birth_date = st.date_input("üìÖ Ng√†y sinh", min_value=datetime(1950, 1, 1), max_value=datetime(2010, 12, 31))
            password = st.text_input("üîí M·∫≠t kh·∫©u", type="password", placeholder="Nh·∫≠p m·∫≠t kh·∫©u")
            confirm_password = st.text_input("üîí X√°c nh·∫≠n m·∫≠t kh·∫©u", type="password", placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u")
            
            if st.form_submit_button("ƒêƒÉng k√Ω", use_container_width=True):
                if all([full_name, email, phone, birth_date, password, confirm_password]):
                    if password == confirm_password:
                        success, message = register_user(full_name, email, phone, birth_date, password)
                        if success:
                            st.success(message)
                        else:
                            st.error(message)
                    else:
                        st.error("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!")
                else:
                    st.error("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!")

def show_main_app():
    user_role = "üëë Qu·∫£n tr·ªã vi√™n" if st.session_state.user['is_admin'] else "üë§ Th√†nh vi√™n"
    
    st.markdown(f"""
        <div class="user-info">
            <h3>Ch√†o m·ª´ng, {st.session_state.user['name']}!</h3>
            <p>{user_role}</p>
        </div>
    """, unsafe_allow_html=True)
    
    show_navigation_menu()
    
    # Main content routing
    if st.session_state.current_page == "üè† Trang ch·ªß":
        show_home_page()
    elif st.session_state.current_page == "‚úÖ Ph√™ duy·ªát th√†nh vi√™n":
        show_approval_page()
    elif st.session_state.current_page == "‚úèÔ∏è Qu·∫£n l√Ω th√†nh vi√™n":
        show_member_management_page()
    elif st.session_state.current_page == "üë• Danh s√°ch th√†nh vi√™n":
        show_members_page()
    elif st.session_state.current_page == "üèÜ X·∫øp h·∫°ng":
        show_ranking_page()
    elif st.session_state.current_page == "üó≥Ô∏è B√¨nh ch·ªçn":
        show_voting_page()
    elif st.session_state.current_page == "üí∞ T√†i ch√≠nh":
        show_finance_page()
    elif st.session_state.current_page == "‚ö†Ô∏è C·∫£nh b√°o":
        show_alerts_page()

def show_navigation_menu():
    menu_items = ["üè† Trang ch·ªß", "üë• Danh s√°ch th√†nh vi√™n", "üèÜ X·∫øp h·∫°ng", "üó≥Ô∏è B√¨nh ch·ªçn", "üí∞ T√†i ch√≠nh", "‚ö†Ô∏è C·∫£nh b√°o"]
    
    if st.session_state.user['is_admin']:
        menu_items.insert(1, "‚úÖ Ph√™ duy·ªát th√†nh vi√™n")
        menu_items.insert(2, "‚úèÔ∏è Qu·∫£n l√Ω th√†nh vi√™n")
    
    st.markdown('<div class="nav-menu">', unsafe_allow_html=True)
    
    cols = st.columns(len(menu_items) + 1)
    
    for i, item in enumerate(menu_items):
        with cols[i]:
            if st.button(item, key=f"nav_{item}", use_container_width=True):
                st.session_state.current_page = item
                st.session_state.editing_member_id = None  # Reset editing state
                st.rerun()
    
    with cols[-1]:
        if st.button("üö™ ƒêƒÉng xu·∫•t", key="logout", use_container_width=True, type="primary"):
            st.session_state.logged_in = False
            st.session_state.user = None
            st.session_state.current_page = "üè† Trang ch·ªß"
            st.session_state.editing_member_id = None
            st.rerun()
    
    st.markdown('</div>', unsafe_allow_html=True)

def show_home_page():
    st.title("üìä Trang ch·ªß - T·ªïng quan")
    
    members_df = get_approved_members()
    rankings_df = get_rankings()
    financial_df = get_financial_summary()
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown(f"""
            <div class="stat-card">
                <div class="stat-number">{len(members_df)}</div>
                <div class="stat-label">üë• T·ªïng s·ªë th√†nh vi√™n</div>
            </div>
        """, unsafe_allow_html=True)
    
    with col2:
        top_wins = rankings_df.iloc[0]['total_wins'] if not rankings_df.empty else 0
        st.markdown(f"""
            <div class="stat-card">
                <div class="stat-number">{top_wins}</div>
                <div class="stat-label">üèÜ Nhi·ªÅu tr·∫≠n th·∫Øng nh·∫•t</div>
            </div>
        """, unsafe_allow_html=True)
    
    with col3:
        total_balance = financial_df['balance'].sum() if not financial_df.empty else 0
        st.markdown(f"""
            <div class="stat-card">
                <div class="stat-number">{total_balance:,}</div>
                <div class="stat-label">üí∞ T·ªïng qu·ªπ (VNƒê)</div>
            </div>
        """, unsafe_allow_html=True)
    
    # BI·ªÇU ƒê·ªí S·ª¨ D·ª§NG STREAMLIT NATIVE
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown('<div class="simple-chart">', unsafe_allow_html=True)
        st.subheader("üèÜ Top 5 th√†nh vi√™n xu·∫•t s·∫Øc")
        if not rankings_df.empty:
            # T·∫°o DataFrame cho bar chart
            top_5 = rankings_df.head(5)
            chart_data = pd.DataFrame({
                'Th√†nh vi√™n': top_5['full_name'],
                'Tr·∫≠n th·∫Øng': top_5['total_wins']
            }).set_index('Th√†nh vi√™n')
            
            st.bar_chart(chart_data, height=300)
        else:
            st.info("Ch∆∞a c√≥ d·ªØ li·ªáu ranking")
        st.markdown('</div>', unsafe_allow_html=True)
    
    with col2:
        st.markdown('<div class="simple-chart">', unsafe_allow_html=True)
        st.subheader("üí∞ Top 5 th√†nh vi√™n ƒë√≥ng g√≥p nhi·ªÅu")
        if not financial_df.empty and financial_df['total_contribution'].sum() > 0:
            contrib_data = financial_df[financial_df['total_contribution'] > 0].head(5)
            if not contrib_data.empty:
                chart_data = pd.DataFrame({
                    'Th√†nh vi√™n': contrib_data['full_name'],
                    'ƒê√≥ng g√≥p (VNƒê)': contrib_data['total_contribution']
                }).set_index('Th√†nh vi√™n')
                
                st.bar_chart(chart_data, height=300)
            else:
                st.info("Ch∆∞a c√≥ ƒë√≥ng g√≥p n√†o")
        else:
            st.info("Ch∆∞a c√≥ d·ªØ li·ªáu t√†i ch√≠nh")
        st.markdown('</div>', unsafe_allow_html=True)
    
    # Database info
    st.subheader("üìä Th√¥ng tin h·ªá th·ªëng")
    if os.path.exists(DB_FILE):
        file_size = os.path.getsize(DB_FILE)
        st.info(f"üíæ **Database SQLite**: {DB_FILE} ({file_size} bytes) - D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ persistent")
    else:
        st.warning("‚ö†Ô∏è Database file kh√¥ng t·ªìn t·∫°i")

def show_approval_page():
    if not st.session_state.user['is_admin']:
        st.error("Ch·ªâ admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p trang n√†y!")
        return
    
    st.title("‚úÖ Ph√™ duy·ªát th√†nh vi√™n")
    
    # Debug info
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute('SELECT COUNT(*) FROM users WHERE is_admin = 0')
        total_non_admin = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM users WHERE is_approved = 0 AND is_admin = 0')
        pending_count = cursor.fetchone()[0]
        conn.close()
        
        st.info(f"üîç Debug: {total_non_admin} users kh√¥ng ph·∫£i admin, {pending_count} users ch·ªù ph√™ duy·ªát")
    except Exception as e:
        st.error(f"Debug error: {str(e)}")
    
    pending_members = get_pending_members()
    
    if pending_members.empty:
        st.success("üéâ Kh√¥ng c√≥ th√†nh vi√™n n√†o c·∫ßn ph√™ duy·ªát!")
        
        # Show all users for debugging
        st.subheader("üîß Debug - T·∫•t c·∫£ users:")
        try:
            conn = get_db_connection()
            all_users = pd.read_sql_query('SELECT full_name, email, is_approved, is_admin FROM users', conn)
            conn.close()
            st.dataframe(all_users)
        except Exception as e:
            st.error(f"L·ªói hi·ªÉn th·ªã users: {str(e)}")
    else:
        st.subheader(f"üìã C√≥ {len(pending_members)} th√†nh vi√™n ch·ªù ph√™ duy·ªát")
        
        for _, member in pending_members.iterrows():
            with st.container():
                col1, col2, col3, col4 = st.columns([2, 2, 1, 1])
                
                with col1:
                    st.markdown(f"""
                        <div class="pending-card">
                            <strong>üë§ {member['full_name']}</strong><br>
                            üìß {member['email']}<br>
                            üì± {member['phone']}<br>
                            üìÖ {member['birth_date']}
                        </div>
                    """, unsafe_allow_html=True)
                
                with col2:
                    st.info(f"üìÖ ƒêƒÉng k√Ω: {member['created_at']}")
                
                with col3:
                    if st.button("‚úÖ Ph√™ duy·ªát", key=f"approve_{member['id']}", use_container_width=True):
                        if approve_member(member['id'], st.session_state.user['name']):
                            st.success(f"ƒê√£ ph√™ duy·ªát {member['full_name']}")
                            st.rerun()
                        else:
                            st.error("L·ªói ph√™ duy·ªát!")
                
                with col4:
                    if st.button("‚ùå T·ª´ ch·ªëi", key=f"reject_{member['id']}", use_container_width=True):
                        if reject_member(member['id']):
                            st.warning(f"ƒê√£ t·ª´ ch·ªëi {member['full_name']}")
                            st.rerun()
                        else:
                            st.error("L·ªói t·ª´ ch·ªëi!")
                
                st.markdown("---")

# TRANG QU·∫¢N L√ù TH√ÄNH VI√äN M·ªöI
def show_member_management_page():
    if not st.session_state.user['is_admin']:
        st.error("Ch·ªâ admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p trang n√†y!")
        return
    
    st.title("‚úèÔ∏è Qu·∫£n l√Ω th√†nh vi√™n")
    
    # Tabs for different management functions
    tab1, tab2, tab3 = st.tabs(["‚ûï Th√™m th√†nh vi√™n", "‚úèÔ∏è S·ª≠a th√†nh vi√™n", "üóëÔ∏è X√≥a th√†nh vi√™n"])
    
    with tab1:
        st.subheader("Th√™m th√†nh vi√™n m·ªõi")
        st.info("üí° Th√†nh vi√™n ƒë∆∞·ª£c th√™m b·ªüi admin s·∫Ω ƒë∆∞·ª£c ph√™ duy·ªát ngay l·∫≠p t·ª©c")
        
        with st.form("add_member_form"):
            col1, col2 = st.columns(2)
            
            with col1:
                full_name = st.text_input("üë§ H·ªç v√† t√™n", placeholder="Nh·∫≠p h·ªç v√† t√™n ƒë·∫ßy ƒë·ªß")
                email = st.text_input("üìß Email", placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ email")
                phone = st.text_input("üì± S·ªë ƒëi·ªán tho·∫°i", placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i")
            
            with col2:
                birth_date = st.date_input("üìÖ Ng√†y sinh", min_value=datetime(1950, 1, 1), max_value=datetime(2010, 12, 31))
                password = st.text_input("üîí M·∫≠t kh·∫©u", type="password", placeholder="Nh·∫≠p m·∫≠t kh·∫©u")
                confirm_password = st.text_input("üîí X√°c nh·∫≠n m·∫≠t kh·∫©u", type="password", placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u")
            
            if st.form_submit_button("üíæ Th√™m th√†nh vi√™n", use_container_width=True):
                if all([full_name, email, phone, birth_date, password, confirm_password]):
                    if password == confirm_password:
                        success, message = add_member_direct(full_name, email, phone, birth_date, password)
                        if success:
                            st.success(message)
                            st.rerun()
                        else:
                            st.error(message)
                    else:
                        st.error("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!")
                else:
                    st.error("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!")
    
    with tab2:
        st.subheader("Ch·ªânh s·ª≠a th√¥ng tin th√†nh vi√™n")
        
        members_df = get_approved_members()
        if members_df.empty:
            st.info("Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë·ªÉ ch·ªânh s·ª≠a")
        else:
            # Member selection
            col1, col2 = st.columns([2, 1])
            with col1:
                member_options = [f"{row['full_name']} ({row['email']})" for _, row in members_df.iterrows()]
                selected_idx = st.selectbox("üë§ Ch·ªçn th√†nh vi√™n c·∫ßn s·ª≠a", range(len(member_options)), format_func=lambda x: member_options[x])
                selected_member = members_df.iloc[selected_idx]
            
            with col2:
                if st.button("üìù Ch·ªçn ƒë·ªÉ s·ª≠a", use_container_width=True):
                    st.session_state.editing_member_id = selected_member['id']
                    st.rerun()
            
            # Edit form
            if st.session_state.editing_member_id:
                member_data = get_member_by_id(st.session_state.editing_member_id)
                if member_data:
                    st.markdown(f"""
                        <div class="edit-form">
                            <h4>‚úèÔ∏è ƒêang s·ª≠a: {member_data['full_name']}</h4>
                        </div>
                    """, unsafe_allow_html=True)
                    
                    with st.form("edit_member_form"):
                        col1, col2 = st.columns(2)
                        
                        with col1:
                            edit_full_name = st.text_input("üë§ H·ªç v√† t√™n", value=member_data['full_name'])
                            edit_email = st.text_input("üìß Email", value=member_data['email'])
                            edit_phone = st.text_input("üì± S·ªë ƒëi·ªán tho·∫°i", value=member_data['phone'])
                        
                        with col2:
                            edit_birth_date = st.date_input("üìÖ Ng√†y sinh", value=datetime.strptime(member_data['birth_date'], '%Y-%m-%d').date())
                            edit_password = st.text_input("üîí M·∫≠t kh·∫©u m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)", type="password")
                            confirm_edit_password = st.text_input("üîí X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi", type="password")
                        
                        col_submit, col_cancel = st.columns(2)
                        
                        with col_submit:
                            if st.form_submit_button("üíæ C·∫≠p nh·∫≠t", use_container_width=True):
                                if edit_password and edit_password != confirm_edit_password:
                                    st.error("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!")
                                else:
                                    success, message = update_member(
                                        st.session_state.editing_member_id,
                                        edit_full_name, edit_email, edit_phone, edit_birth_date,
                                        edit_password if edit_password else None
                                    )
                                    if success:
                                        st.success(message)
                                        st.session_state.editing_member_id = None
                                        st.rerun()
                                    else:
                                        st.error(message)
                        
                        with col_cancel:
                            if st.form_submit_button("‚ùå H·ªßy", use_container_width=True):
                                st.session_state.editing_member_id = None
                                st.rerun()
    
    with tab3:
        st.subheader("X√≥a th√†nh vi√™n")
        st.warning("‚ö†Ô∏è **C·∫£nh b√°o**: X√≥a th√†nh vi√™n s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu li√™n quan (rankings, votes, finances)")
        
        members_df = get_approved_members()
        if members_df.empty:
            st.info("Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë·ªÉ x√≥a")
        else:
            col1, col2 = st.columns(2)
            
            with col1:
                st.subheader("üìã Danh s√°ch th√†nh vi√™n")
                for _, member in members_df.iterrows():
                    st.markdown(f"""
                        <div class="member-card">
                            <strong>üë§ {member['full_name']}</strong><br>
                            üìß {member['email']}<br>
                            üì± {member['phone']}
                        </div>
                    """, unsafe_allow_html=True)
                    
                    if st.button(f"üóëÔ∏è X√≥a {member['full_name']}", key=f"delete_{member['id']}", type="secondary", use_container_width=True):
                        # Confirmation dialog
                        with col2:
                            st.error(f"‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a **{member['full_name']}**?")
                            st.write("H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")
                            
                            col_confirm, col_cancel_delete = st.columns(2)
                            
                            with col_confirm:
                                if st.button("‚úÖ X√°c nh·∫≠n x√≥a", key=f"confirm_delete_{member['id']}", type="primary", use_container_width=True):
                                    success, message = delete_member(member['id'])
                                    if success:
                                        st.success(message)
                                        st.rerun()
                                    else:
                                        st.error(message)
                            
                            with col_cancel_delete:
                                if st.button("‚ùå H·ªßy", key=f"cancel_delete_{member['id']}", use_container_width=True):
                                    st.rerun()

def show_members_page():
    st.title("üë• Danh s√°ch th√†nh vi√™n")
    
    members_df = get_approved_members()
    
    if members_df.empty:
        st.info("Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë∆∞·ª£c ph√™ duy·ªát")
    else:
        st.subheader(f"üìä T·ªïng s·ªë: {len(members_df)} th√†nh vi√™n")
        
        search_term = st.text_input("üîç T√¨m ki·∫øm th√†nh vi√™n", placeholder="Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm...")
        
        if search_term:
            members_df = members_df[members_df['full_name'].str.contains(search_term, case=False, na=False)]
        
        if not members_df.empty:
            display_df = members_df.copy()
            display_df.index = range(1, len(display_df) + 1)
            
            st.dataframe(
                display_df.rename(columns={
                    'full_name': 'H·ªç v√† t√™n',
                    'phone': 'S·ªë ƒëi·ªán tho·∫°i',
                    'birth_date': 'Ng√†y sinh'
                })[['H·ªç v√† t√™n', 'S·ªë ƒëi·ªán tho·∫°i', 'Ng√†y sinh']],
                use_container_width=True
            )

def show_ranking_page():
    st.title("üèÜ X·∫øp h·∫°ng th√†nh vi√™n")
    
    rankings_df = get_rankings()
    
    if st.session_state.user['is_admin']:
        with st.expander("‚ûï Th√™m k·∫øt qu·∫£ tr·∫≠n ƒë·∫•u"):
            with st.form("add_ranking_form"):
                col1, col2 = st.columns(2)
                
                with col1:
                    members = get_approved_members()['full_name'].tolist() if not get_approved_members().empty else []
                    if members:
                        selected_member = st.selectbox("üë§ Ch·ªçn th√†nh vi√™n", members)
                        wins = st.number_input("üèÜ S·ªë tr·∫≠n th·∫Øng", min_value=1, max_value=10, value=1)
                        match_date = st.date_input("üìÖ Ng√†y thi ƒë·∫•u", value=datetime.now().date())
                    else:
                        st.warning("Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë∆∞·ª£c ph√™ duy·ªát")
                        selected_member = None
                
                with col2:
                    location = st.text_input("üìç ƒê·ªãa ƒëi·ªÉm", placeholder="VD: S√¢n ABC")
                    score = st.text_input("üìä T·ª∑ s·ªë", placeholder="VD: 11-8, 11-6")
                
                if st.form_submit_button("üíæ L∆∞u k·∫øt qu·∫£", use_container_width=True):
                    if selected_member and location and score:
                        if add_ranking(selected_member, wins, match_date, location, score):
                            st.success(f"ƒê√£ th√™m {wins} tr·∫≠n th·∫Øng cho {selected_member}")
                            st.rerun()
    
    if rankings_df.empty:
        st.info("Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng")
    else:
        st.subheader("üìà B·∫£ng x·∫øp h·∫°ng")
        
        # Hi·ªÉn th·ªã ranking cards
        for idx, (_, player) in enumerate(rankings_df.iterrows(), 1):
            medal = "ü•á" if idx == 1 else "ü•à" if idx == 2 else "ü•â" if idx == 3 else "üèÖ"
            
            st.markdown(f"""
                <div class="ranking-card">
                    <h3>{medal} #{idx} - {player['full_name']}</h3>
                    <h2>üèÜ {player['total_wins']} tr·∫≠n th·∫Øng</h2>
                </div>
            """, unsafe_allow_html=True)
        
        # BI·ªÇU ƒê·ªí STREAMLIT NATIVE
        if len(rankings_df) > 1:
            st.subheader("üìä Bi·ªÉu ƒë·ªì x·∫øp h·∫°ng")
            chart_data = rankings_df.head(10).set_index('full_name')
            st.bar_chart(chart_data['total_wins'], height=400)

def show_voting_page():
    st.title("üó≥Ô∏è B√¨nh ch·ªçn tham gia")
    
    if st.session_state.user['is_admin']:
        with st.expander("‚ûï T·∫°o phi√™n b√¨nh ch·ªçn m·ªõi"):
            with st.form("create_vote_form"):
                col1, col2 = st.columns(2)
                
                with col1:
                    session_date = st.date_input("üìÖ Ng√†y ch∆°i", min_value=datetime.now().date())
                
                with col2:
                    description = st.text_input("üìù M√¥ t·∫£", placeholder="VD: Giao l∆∞u cu·ªëi tu·∫ßn")
                
                if st.form_submit_button("üó≥Ô∏è T·∫°o phi√™n b√¨nh ch·ªçn", use_container_width=True):
                    if description:
                        if create_vote_session(session_date, description):
                            st.success("ƒê√£ t·∫°o phi√™n b√¨nh ch·ªçn m·ªõi!")
                            st.rerun()
    
    vote_sessions = get_vote_sessions()
    
    if vote_sessions.empty:
        st.info("Ch∆∞a c√≥ phi√™n b√¨nh ch·ªçn n√†o")
    else:
        st.subheader("üìã C√°c phi√™n b√¨nh ch·ªçn")
        
        for _, session in vote_sessions.iterrows():
            with st.container():
                col1, col2, col3 = st.columns([3, 1, 1])
                
                with col1:
                    st.markdown(f"""
                        <div class="vote-card">
                            <h4>üìÖ {session['session_date']}</h4>
                            <p>üìù {session['description']}</p>
                            <p>üë• <strong>{session['vote_count']}</strong> th√†nh vi√™n tham gia</p>
                        </div>
                    """, unsafe_allow_html=True)
                
                with col2:
                    if not st.session_state.user['is_admin']:
                        if st.button("üó≥Ô∏è Vote", key=f"vote_{session['id']}", use_container_width=True):
                            success = vote_for_session(st.session_state.user['id'], session['session_date'])
                            if success:
                                st.success("ƒê√£ vote th√†nh c√¥ng!")
                                st.rerun()
                            else:
                                st.warning("B·∫°n ƒë√£ vote cho phi√™n n√†y!")
                    else:
                        st.info("Admin kh√¥ng th·ªÉ vote")
                
                with col3:
                    if st.button("üëÅÔ∏è Chi ti·∫øt", key=f"detail_{session['id']}", use_container_width=True):
                        vote_details = get_vote_details(session['session_date'])
                        
                        with st.expander(f"Chi ti·∫øt phi√™n {session['session_date']}", expanded=True):
                            if not vote_details.empty:
                                for _, voter in vote_details.iterrows():
                                    st.markdown(f"""
                                        <div class="member-card">
                                            üë§ <strong>{voter['full_name']}</strong><br>
                                            üïí {voter['created_at']}
                                        </div>
                                    """, unsafe_allow_html=True)
                            else:
                                st.info("Ch∆∞a c√≥ th√†nh vi√™n n√†o vote cho phi√™n n√†y")

def show_finance_page():
    st.title("üí∞ Qu·∫£n l√Ω t√†i ch√≠nh")
    
    if st.session_state.user['is_admin']:
        col1, col2 = st.columns(2)
        
        with col1:
            with st.expander("‚ûï Th√™m ƒë√≥ng g√≥p"):
                with st.form("add_contribution_form"):
                    members_df = get_approved_members()
                    members = members_df['full_name'].tolist() if not members_df.empty else []
                    if members:
                        member_name = st.selectbox("üë§ Th√†nh vi√™n", members)
                        amount = st.number_input("üíµ S·ªë ti·ªÅn (VNƒê)", min_value=10000, step=10000)
                        
                        if st.form_submit_button("üíæ L∆∞u", use_container_width=True):
                            if add_contribution(member_name, amount):
                                st.success(f"ƒê√£ th√™m {amount:,} VNƒê cho {member_name}")
                                st.rerun()
                    else:
                        st.warning("Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë∆∞·ª£c ph√™ duy·ªát")
        
        with col2:
            with st.expander("‚ûï Th√™m chi ph√≠ bu·ªïi t·∫≠p"):
                vote_sessions_df = get_vote_sessions_for_expense()
                
                if not vote_sessions_df.empty:
                    with st.form("add_expense_form"):
                        session_options = []
                        for _, row in vote_sessions_df.iterrows():
                            session_options.append(f"{row['session_date']} - {row['description']} ({row['vote_count']} ng∆∞·ªùi)")
                        
                        selected_session_idx = st.selectbox("üìÖ Ch·ªçn bu·ªïi t·∫≠p", range(len(session_options)), 
                                                           format_func=lambda x: session_options[x])
                        selected_session = vote_sessions_df.iloc[selected_session_idx]
                        
                        st.info(f"üí° Chi ph√≠ s·∫Ω ƒë∆∞·ª£c chia ƒë·ªÅu cho {selected_session['vote_count']} th√†nh vi√™n")
                        
                        court_fee = st.number_input("üè∏ Ti·ªÅn s√¢n (VNƒê)", min_value=0, step=10000, value=200000)
                        water_fee = st.number_input("üíß Ti·ªÅn n∆∞·ªõc (VNƒê)", min_value=0, step=5000, value=50000)
                        other_fee = st.number_input("‚ûï Chi ph√≠ kh√°c (VNƒê)", min_value=0, step=5000, value=0)
                        description = st.text_input("üìù Ghi ch√∫", value="Chi ph√≠ bu·ªïi t·∫≠p")
                        
                        total = court_fee + water_fee + other_fee
                        if total > 0:
                            cost_per_person = total // selected_session['vote_count']
                            st.success(f"üí∞ T·ªïng: {total:,} VNƒê | M·ªói ng∆∞·ªùi: {cost_per_person:,} VNƒê")
                        
                        if st.form_submit_button("üíæ L∆∞u chi ph√≠", use_container_width=True):
                            if total > 0:
                                success, message = add_expense(selected_session['session_date'], court_fee, water_fee, other_fee, description)
                                if success:
                                    st.success(message)
                                    st.rerun()
                                else:
                                    st.error(message)
                else:
                    st.warning("Ch∆∞a c√≥ bu·ªïi t·∫≠p n√†o c√≥ vote")
    
    # Expense history
    st.subheader("üìã L·ªãch s·ª≠ chi ph√≠ c√°c bu·ªïi t·∫≠p")
    expense_history = get_expense_history()
    
    if not expense_history.empty:
        for _, expense in expense_history.iterrows():
            st.markdown(f"""
                <div class="expense-card">
                    <h4>üìÖ {expense['session_date']} - {expense['description']}</h4>
                    <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                        <div>
                            <strong>üë• S·ªë ng∆∞·ªùi tham gia:</strong> {expense['participants_count']}<br>
                            <strong>üë§ Chi ph√≠/ng∆∞·ªùi:</strong> {expense['cost_per_person']:,} VNƒê
                        </div>
                        <div style="text-align: right;">
                            <strong>üí∞ T·ªïng chi ph√≠:</strong> {expense['total_cost']:,} VNƒê
                        </div>
                    </div>
                </div>
            """, unsafe_allow_html=True)
    else:
        st.info("Ch∆∞a c√≥ chi ph√≠ n√†o ƒë∆∞·ª£c ghi nh·∫≠n")
    
    # Financial summary
    financial_df = get_financial_summary()
    
    if not financial_df.empty:
        st.subheader("üìä T·ªïng quan t√†i ch√≠nh th√†nh vi√™n")
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            total_contributions = financial_df['total_contribution'].sum()
            st.metric("üí∞ T·ªïng ƒë√≥ng g√≥p", f"{total_contributions:,} VNƒê")
        
        with col2:
            total_expenses = abs(financial_df['total_expenses'].sum())
            st.metric("üí∏ T·ªïng chi ph√≠", f"{total_expenses:,} VNƒê")
        
        with col3:
            total_balance = financial_df['balance'].sum()
            st.metric("üè¶ S·ªë d∆∞ qu·ªπ", f"{total_balance:,} VNƒê")
        
        with col4:
            avg_sessions = financial_df['sessions_attended'].mean()
            st.metric("üìä TB bu·ªïi tham gia", f"{avg_sessions:.1f}")
        
        st.subheader("üìã Chi ti·∫øt t√†i ch√≠nh t·ª´ng th√†nh vi√™n")
        
        display_df = financial_df.copy()
        display_df['total_contribution'] = display_df['total_contribution'].apply(lambda x: f"{x:,} VNƒê")
        display_df['total_expenses'] = display_df['total_expenses'].apply(lambda x: f"{abs(x):,} VNƒê")
        display_df['balance'] = display_df['balance'].apply(lambda x: f"{x:,} VNƒê")
        display_df.index = range(1, len(display_df) + 1)
        
        st.dataframe(
            display_df.rename(columns={
                'full_name': 'T√™n th√†nh vi√™n',
                'total_contribution': 'ƒê√£ ƒë√≥ng g√≥p',
                'sessions_attended': 'Bu·ªïi tham gia',
                'total_expenses': 'T·ªïng chi ph√≠',
                'balance': 'S·ªë d∆∞'
            }),
            use_container_width=True
        )
        
        # BI·ªÇU ƒê·ªí STREAMLIT NATIVE
        col1, col2 = st.columns(2)
        
        with col1:
            st.subheader("üìä S·ªë d∆∞ th√†nh vi√™n")
            if len(financial_df) > 0:
                balance_chart = financial_df.set_index('full_name')['balance']
                st.bar_chart(balance_chart, height=300)
            else:
                st.info("Ch∆∞a c√≥ d·ªØ li·ªáu")
        
        with col2:
            st.subheader("üí∞ Top ƒë√≥ng g√≥p")
            contrib_data = financial_df[financial_df['total_contribution'] > 0].head(5)
            if not contrib_data.empty:
                contrib_chart = contrib_data.set_index('full_name')['total_contribution']
                st.bar_chart(contrib_chart, height=300)
            else:
                st.info("Ch∆∞a c√≥ ƒë√≥ng g√≥p n√†o")

def show_alerts_page():
    st.title("‚ö†Ô∏è C·∫£nh b√°o h·ªá th·ªëng")
    
    alerts = get_alerts()
    
    if not alerts:
        st.success("üéâ Kh√¥ng c√≥ c·∫£nh b√°o n√†o!")
    else:
        st.subheader(f"üö® C√≥ {len(alerts)} c·∫£nh b√°o c·∫ßn ch√∫ √Ω")
        
        for alert in alerts:
            if "s·ªë d∆∞ th·∫•p" in alert:
                st.markdown(f'<div class="danger-card">{alert}</div>', unsafe_allow_html=True)
            else:
                st.markdown(f'<div class="alert-card">{alert}</div>', unsafe_allow_html=True)
    
    # System statistics
    st.subheader("üìä Th·ªëng k√™ h·ªá th·ªëng")
    
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            cursor.execute('SELECT COUNT(*) FROM users WHERE is_approved = 0 AND is_admin = 0')
            pending_count = cursor.fetchone()[0]
            st.metric("‚è≥ Ch·ªù ph√™ duy·ªát", pending_count)
        
        with col2:
            cursor.execute('SELECT COUNT(*) FROM users WHERE is_approved = 1 AND is_admin = 0')
            approved_count = cursor.fetchone()[0]
            st.metric("‚úÖ Th√†nh vi√™n active", approved_count)
        
        with col3:
            seven_days_ago = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')
            cursor.execute('''
                SELECT COUNT(*) FROM votes v
                JOIN users u ON v.user_id = u.id
                WHERE v.created_at >= ? AND u.is_admin = 0
            ''', (seven_days_ago,))
            recent_votes = cursor.fetchone()[0]
            st.metric("üó≥Ô∏è Vote tu·∫ßn n√†y", recent_votes)
        
        conn.close()
    except Exception as e:
        st.error(f"L·ªói th·ªëng k√™: {str(e)}")

if __name__ == "__main__":
    main()